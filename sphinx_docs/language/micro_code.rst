.. _micro_code:

Micro Code
==========

Microcode is the encoding of what specific steps the computer should take to
complete an instruction.

It is effectively a large combinational logic circuit where the inputs are the
instruction byte, microcode step and flag bits and the outputs are the control
signals to drive the modules. EEPROM chips are programmed and used to implement
this combinational logic circuit. The same address is fed into 4
chips to get the 30 output bits.

Every instruction is comprised of up to 6 steps (There are eight available but
the first two are reserved for fetching the instruction byte itself). The steps
are executed sequentially to perform the instruction. The microcode step counter
controls the order of the sequence. The flags bits allow conditional operation
based on a given instruction byte and step. An instruction can "surrender" it's
remaining steps and move onto the next instruction if it has completed all it's
necessary steps.

Address bits
------------

The address bits for the EEPROM and their meanings are:

+---------------------+-------------------+
| Bits                | Meaning           |
+=====================+===================+
| ``xxxxxxxx.......`` | Instruction byte. |
+---------------------+-------------------+
| ``........xxxx...`` | Flags.            |
+---------------------+-------------------+
| ``............xxx`` | Microcode step.   |
+---------------------+-------------------+

Output bits
-----------

The output bits for the EEPROMs and their meanings are:

+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| Bits                                    | Name             | Description                                                                                         |
+=========================================+==================+=====================================================================================================+
| ``x....... ........ ........ ........`` | ACC_IN           | Enable input for the accumulator register.                                                          |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``.x...... ........ ........ ........`` | ACC_OUT          | Enable output for the accumulator register.                                                         |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``..x..... ........ ........ ........`` | A_IN             | Enable input for the A register.                                                                    |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``...x.... ........ ........ ........`` | A_OUT            | Enable output for the A register.                                                                   |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``....x... ........ ........ ........`` | B_IN             | Enable input for the B register.                                                                    |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``.....x.. ........ ........ ........`` | B_OUT            | Enable output for the B register.                                                                   |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``......x. ........ ........ ........`` | C_IN             | Enable input for the C register.                                                                    |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``.......x ........ ........ ........`` | C_OUT            | Enable output for the C register.                                                                   |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ x....... ........ ........`` | ALU_STORE_RESULT | Store the current output of the ALU.                                                                |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ .x...... ........ ........`` | ALU_STORE_FLAGS  | Store the current flags of the ALU..                                                                |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ ..x..... ........ ........`` | ALU_OUT          | Enable output for the ALU.                                                                          |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ ...x.... ........ ........`` | ALU_A_IS_BUS     | Set the A input of the ALU to be the bus (otherwise it is the content of the accumulator register). |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ ....x... ........ ........`` | ALU_S0           | Set the S0 function select input on the ALU.                                                        |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ .....x.. ........ ........`` | ALU_S1           | Set the S1 function select input on the ALU.                                                        |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ ......x. ........ ........`` | ALU_S2           | Set the S2 function select input on the ALU.                                                        |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ .......x ........ ........`` | ALU_S3           | Set the S3 function select input on the ALU.                                                        |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ ........ x....... ........`` | ALU_M            | Set the M input on the ALU.                                                                         |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+
| ``........ ........ .x...... ........`` | ALU_C_IN         | Set the carry in input on the ALU.                                                                  |
+-----------------------------------------+------------------+-----------------------------------------------------------------------------------------------------+

    },
    "ALU": {
        "STORE_RESULT":     rw("........ 1....... ........ ........"),
        "STORE_FLAGS":      rw("........ .1...... ........ ........"),
        "OUT":              rw("........ ..1..... ........ ........"),
        "A_IS_BUS":         rw("........ ...1.... ........ ........"),
        "S0":               rw("........ ....1... ........ ........"),
        "S1":               rw("........ .....1.. ........ ........"),
        "S2":               rw("........ ......1. ........ ........"),
        "S3":               rw("........ .......1 ........ ........"),
        "M":                rw("........ ........ 1....... ........"),
        "C_IN":             rw("........ ........ .1...... ........"),
    },
    "MAR": {
        "IN":               rw("........ ........ ..1..... ........"),
    },
    "RAM": {
        "IN":               rw("........ ........ ...1.... ........"),
        "OUT":              rw("........ ........ ....1... ........"),
        "SEL_PROG_MEM":     rw("........ ........ .....1.. ........"),
    },
    "SP": {
        "IN":               rw("........ ........ ......1. ........"),
        "OUT":              rw("........ ........ .......1 ........"),
    },
    "PC": {
        "IN":               rw("........ ........ ........ 1......."),
        "OUT":              rw("........ ........ ........ .1......"),
        "COUNT":            rw("........ ........ ........ ..1....."),
    },
    "IR": {
        "IN":               rw("........ ........ ........ ...1...."),
    },
    "CU": {
        "STEP_RESET":       rw("........ ........ ........ ....1..."),
    },
    "CLOCK": {
        "HALT":             rw("........ ........ ........ .....1.."),






Fetch
-----

To execute an instruction, the instruction byte must be loaded from program
memory into the instruction register.

This is handled by the first two steps of every instruction which:

- Load the program counter into the memory address register.
- Load the instruction register with the data from program memory at increment
  the program counter ready for the next instruction.

Microcode step counter
----------------------

Flags
-----

ROMs
----
